apiVersion: policies.kyverno.io/v1beta1
kind: ValidatingPolicy
metadata:
  name: validate-with-http
spec:
  validationActions:
    - Deny
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: [CREATE, UPDATE]
        resources: [pods]
  variables:
    - name: apiResponse
      expression: >-
        http.Get("http://external-api.example.com/v1/validate", 
                 {"Authorization": "Bearer test-token"})
  validations:
    - expression: >-
        has(variables.apiResponse) && 
        variables.apiResponse.status == "approved" &&
        object.metadata.labels.app in variables.apiResponse.allowedApps
      messageExpression: >-
        'External API validation failed. Status: ' + 
        string(variables.apiResponse.status) + 
        ', App: ' + string(object.metadata.labels.app)
