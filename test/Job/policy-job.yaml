apiVersion: kyverno.io/v1alpha1
kind: Policy
metadata:
  name: policy-job-perl-bigint
spec :
  rules:
    - name: job1
      resource:
        kinds:
        - Job
        name: pi
      mutate:
        overlay:
          metadata:
            labels:
              isOverlayed: "true"
          spec:
            template:
              spec:
                containers:
                  - name: "pi1"
                    image: "vasylev.perl"
                  - name: "pi2"
                    image: "maxov.perl"
        patches:
        - path : "/spec/template/spec/containers/0/command"
          op : add
          value: [ "-Mbignum=bpi", "-wle", "print bpi(2000)" ]
        - path : "/spec/backoffLimit"
          op: add
          value: 10
      validate:
        message: "This job should not be restarted"
        pattern:
          spec:
            template:
              spec:
                restartPolicy: Never
    - name: job2
      resource:
        kinds:
        - Job
        name: pi
      mutate:
        overlay:
          spec:
            template:
              spec:
                containers:
                - (name): piv0
                  ports:
                  - containerPort: 80
                    protocol: TCP
