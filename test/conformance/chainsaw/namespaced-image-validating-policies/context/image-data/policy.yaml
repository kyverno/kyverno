apiVersion: policies.kyverno.io/v1alpha1
kind: NamespacedImageValidatingPolicy
metadata:
  name: nivpol-image-data
  namespace: test-nivpol
spec:
  webhookConfiguration:
    timeoutSeconds: 20
  failurePolicy: Ignore
  validationActions:
  - Deny
  matchConstraints:
    resourceRules:
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["deployments"]
  matchConditions:
    - name: "check-prod-label"
      expression: >-
        has(object.metadata.labels) && has(object.metadata.labels.prod) && object.metadata.labels.prod == 'true'
  matchImageReferences:
    - glob: ghcr.io/*
  validations:
    - expression: >-
        size(images.containers) > 0
      message: deployment must reference at least one image


