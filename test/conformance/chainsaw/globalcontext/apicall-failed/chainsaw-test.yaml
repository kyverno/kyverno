apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: apicall-failed
spec:
  concurrent: false
  steps:
    - name: setup
      try:
        - apply:
            file: namespace.yaml
        - apply:
            file: main-deployment.yaml
        - apply:
            file: gctxentry.yaml
        - sleep:
            duration: 3s
    - name: create policy
      use:
        template: ../../_step-templates/create-policy.yaml
        with:
          bindings:
            - name: file
              value: clusterpolicy.yaml
    - name: wait policy ready
      use:
        template: ../../_step-templates/cluster-policy-ready.yaml
        with:
          bindings:
            - name: name
              value: cpol-apicall-failed
    - name: create new deployment
      try:
        - script:
            content: kubectl apply -f new-deployment.yaml
            check:
              ($error != null): true
              # This check ensures the contents of stderr contain the improved error message.
              "(contains(trim_space($stderr), 'permission denied: Kyverno service account lacks RBAC permissions to GET resource at /apis/apps/v1/namespaces/default/unknown'))": true
