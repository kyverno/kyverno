apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: ($test.metadata.name)
status:
  autogen:
    rules:
    - match:
        any:
        - resources:
            kinds:
            - apps/v1/DaemonSet
            - apps/v1/Deployment
            - batch/v1/Job
            - apps/v1/ReplicaSet
            - v1/ReplicationController
            - apps/v1/StatefulSet
      name: autogen-allowed-fluxcd-annotations
      validate:
        deny:
          conditions:
            all:
            - key: '{{ request.object.spec.template.metadata.annotations.keys(@)[?contains(@, ''fluxcd.io/'')] }}'
              operator: AnyNotIn
              value:
              - fluxcd.io/cow
              - fluxcd.io/dog
        message: The only approved FluxCD annotations are `fluxcd.io/cow` and `fluxcd.io/dog`.
    - match:
        any:
        - resources:
            kinds:
            - batch/v1/CronJob
      name: autogen-cronjob-allowed-fluxcd-annotations
      validate:
        deny:
          conditions:
            all:
            - key: '{{ request.object.spec.jobTemplate.spec.template.metadata.annotations.keys(@)[?contains(@, ''fluxcd.io/'')] }}'
              operator: AnyNotIn
              value:
              - fluxcd.io/cow
              - fluxcd.io/dog
        message: The only approved FluxCD annotations are `fluxcd.io/cow` and `fluxcd.io/dog`.
