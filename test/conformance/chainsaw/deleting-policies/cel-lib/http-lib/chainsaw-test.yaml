apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: deleting-policy-http-lib
spec:
  steps:
    - name: setup-http-service
      try: 
        - apply:
            file: rbac.yaml
        - apply:
            file: http-pod.yaml
        - apply:
            file: service.yaml
        - script:
            content: |
              #!/bin/sh
              set -eu
              kubectl wait --for=condition=Ready pod/test-api -n default --timeout=60s
              # basic readiness probe
              for i in 1 2 3 4 5 6 7 8 9 10; do
                if kubectl run --rm -i --restart=Never --image=curlimages/curl:8.0.1 -n default curl -- -sSf http://test-api-service.default.svc.cluster.local/ >/dev/null 2>&1; then
                  exit 0
                fi
                sleep 1
              done
              echo "service not ready" >&2
              exit 1

    - name: create-test-resources
      try:
        - apply:
            file: pod.yaml

    - name: create-policy
      try:
        - apply:
            file: policy.yaml

    - name: wait-for-deletion
      try:
        - script:
            content: |
              #!/bin/sh
              set -eu
              # Wait for the deleting policy to process the pod deletion
              # Check every 5s for up to 60s
              for i in $(seq 1 12); do
                if ! kubectl get pod test-pod -n default >/dev/null 2>&1; then
                  echo "Pod deletion completed"
                  exit 0
                fi
                echo "Waiting for pod deletion... attempt $i/12"
                sleep 5
              done
              echo "Pod deletion timed out"
              exit 1
            
    - name: verify-deletion
      try:
        - error:
            file: pod-assert.yaml