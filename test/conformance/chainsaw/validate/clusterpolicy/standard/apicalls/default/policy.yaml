apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: default
spec:
  validationFailureAction: Enforce
  rules:
  - name: limit-lb-svc
    match:
      any:
      - resources:
          kinds:
          - Service
          operations:
          - CREATE
    context:
    - name: serviceCount
      apiCall:
        urlPath: "/api/v1/namespaces/{{ request.namespace }}/services/invalidurl"
        jmesPath: "items[?spec.type == 'LoadBalancer'] | length(@)"
        default: '{ subjectaccessreview.status.allowed }'
    validate:
      message: "Only one LoadBalancer service is allowed per namespace"
      deny:
        conditions:
          any:
          - key: "{{ serviceCount }}"
            operator: GreaterThan
            value: 1