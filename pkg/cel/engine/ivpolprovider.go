package engine

import (
	"context"

	"github.com/kyverno/kyverno/api/policies.kyverno.io/v1alpha1"
	policiesv1alpha1 "github.com/kyverno/kyverno/api/policies.kyverno.io/v1alpha1"
	"github.com/kyverno/kyverno/pkg/cel/autogen"
	admissionregistrationv1 "k8s.io/api/admissionregistration/v1"
	"k8s.io/apimachinery/pkg/util/sets"
)

func NewIVPOLProvider(policies []v1alpha1.ImageValidatingPolicy, exceptions []*policiesv1alpha1.PolicyException) (ImageVerifyPolProviderFunc, error) {
	compiled := make([]CompiledImageValidatingPolicy, 0, len(policies))
	for _, policy := range policies {
		p := policy
		var matchedExceptions []*policiesv1alpha1.PolicyException
		for _, polex := range exceptions {
			for _, ref := range polex.Spec.PolicyRefs {
				if ref.Name == p.GetName() && ref.Kind == p.GetKind() {
					matchedExceptions = append(matchedExceptions, polex)
				}
			}
		}
		actions := sets.New(policy.Spec.ValidationAction...)
		if len(actions) == 0 {
			actions.Insert(admissionregistrationv1.Deny)
		}
		compiled = append(compiled, CompiledImageValidatingPolicy{
			Actions:    actions,
			Policy:     &p,
			Exceptions: matchedExceptions,
		})

		autogeneratedIvPols, err := autogen.GetAutogenRulesImageVerify(&p)
		if err != nil {
			return nil, err
		}

		for _, ap := range autogeneratedIvPols {
			compiled = append(compiled, CompiledImageValidatingPolicy{
				Actions: actions,
				Policy: &v1alpha1.ImageValidatingPolicy{
					Spec: ap.Spec,
				},
			})
		}
	}
	provider := func(context.Context) ([]CompiledImageValidatingPolicy, error) {
		return compiled, nil
	}
	return provider, nil
}
