# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Conformance tests

permissions: {}

on:
  pull_request:
    branches:
      - main
      - release*
  merge_group:
    types: [checks_requested]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # v1.3.1
        with:
          android: true
          docker-images: false
          dotnet: false
          haskell: false
          large-packages: false
          swap-storage: false
          tool-cache: false
      - name: Setup Go
        id: setup-go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache: false
      - name: Set cache variables
        shell: bash
        run: |
          set -e
          echo "GO_MOD_CACHE=$(go env GOMODCACHE)" >> $GITHUB_ENV
          echo "GO_BUILD_CACHE=$(go env GOCACHE)" >> $GITHUB_ENV
          echo "GO_CACHE_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
          echo "ARCH=$(echo '${{ runner.arch }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          echo "CACHE_OS_SUFFIX=$ImageOS-" >> $GITHUB_ENV
      - name: Restore gomod cache
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ env.GO_MOD_CACHE }}
          key: gomod-${{ runner.os }}-${{ env.ARCH }}-${{ env.CACHE_OS_SUFFIX }}go-${{ steps.setup-go.outputs.go-version }}-${{ env.GO_CACHE_DATE }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            gomod-${{ runner.os }}-${{ env.ARCH }}-${{ env.CACHE_OS_SUFFIX }}go-${{ steps.setup-go.outputs.go-version }}-${{ env.GO_CACHE_DATE }}-
            gomod-${{ runner.os }}-${{ env.ARCH }}-${{ env.CACHE_OS_SUFFIX }}go-${{ steps.setup-go.outputs.go-version }}-
      - name: Restore gobuild cache
        if: github.ref != 'refs/heads/main'
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ${{ env.GO_BUILD_CACHE }}
          key: gobuild-${{ runner.os }}-${{ env.ARCH }}-${{ env.CACHE_OS_SUFFIX }}go-${{ steps.setup-go.outputs.go-version }}-${{ env.GO_CACHE_DATE }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            gobuild-${{ runner.os }}-${{ env.ARCH }}-${{ env.CACHE_OS_SUFFIX }}go-${{ steps.setup-go.outputs.go-version }}-${{ env.GO_CACHE_DATE }}-
            gobuild-${{ runner.os }}-${{ env.ARCH }}-${{ env.CACHE_OS_SUFFIX }}go-${{ steps.setup-go.outputs.go-version }}-
      - name: Install Ko
        uses: ko-build/setup-ko@d006021bd0c28d1ce33a07e7943d48b079944c8d # v0.9
      - name: Ko build
        shell: bash
        run: |
          set -e
          KO=/usr/local/bin/ko VERSION=${{ github.ref_name }} make docker-save-image-all
      - name: Upload images archive
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: kyverno.tar
          path: kyverno.tar
          retention-days: 1
          if-no-files-found: error
      - name: Build CLI
        shell: bash
        run: |
          set -e
          VERSION=${{ github.ref_name }} make build-cli
      - name: Upload binary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: kubectl-kyverno
          path: cmd/cli/kubectl-kyverno/kubectl-kyverno
          retention-days: 1
          if-no-files-found: error

  assert:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: assert

  autogen:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: autogen

  background-only:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: background-only

  cleanup:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: cleanup

  custom-sigstore:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - v1.33.x
          - v1.34.x
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      # install tools
      - name: Install helm
        id: helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
      - name: Install crane
        uses: imjasonh/setup-crane@6da1ae018866400525525ce74ff892880c099987 # v0.5
      - name: Install Cosign
        uses: sigstore/cosign-installer@fb28c2b6339dcd94da6e4cbcbc5e888961f6f8c3 # v3.9.0
      - name: Install chainsaw
        uses: kyverno/action-install-chainsaw@06560d18422209e9c1e08e931d477d04bf2674c1 # v0.2.14
        with:
          verify: true
          release: v0.2.15-beta.3
      # create cluster
      - name: Create kind cluster and setup Sigstore Scaffolding
        uses: sigstore/scaffolding/actions/setup@8bd68672d418e5bd1b0ee1f2e2981874c3a30967 # v0.7.33
        with:
          version: main
          k8s-version: ${{ matrix.k8s-version }}
          knative-version: "1.10.0"
      - name: Create TUF values config map
        run: |
          set -e
          kubectl create namespace kyverno
          kubectl -n kyverno create configmap tufvalues --from-literal=TUF_MIRROR=$TUF_MIRROR --from-literal=FULCIO_URL=$FULCIO_URL --from-literal=REKOR_URL=$REKOR_URL --from-literal=CTLOG_URL=$CTLOG_URL --from-literal=ISSUER_URL=$ISSUER_URL
          kubectl -n tuf-system get secrets tuf-root -oyaml | sed 's/namespace: .*/namespace: kyverno/' | kubectl create -f -
      # deploy kyverno
      - name: Download kyverno images archive
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: kyverno.tar
      - name: Load kyverno images archive in kind cluster
        shell: bash
        run: |
          set -e
          kind load image-archive kyverno.tar --name kind
      - name: Install kyverno
        shell: bash
        run: |
          set -e
          export HELM=${{ steps.helm.outputs.helm-path }}
          export USE_CONFIG=standard,custom-sigstore
          make kind-install-kyverno
      - name: Wait for kyverno ready
        uses: ./.github/actions/kyverno-wait-ready
      # prepare test image
      - name: Create test image
        shell: bash
        run: |
          DIGEST=$(crane digest cgr.dev/chainguard/static)
          IMAGE_NAME=$(uuidgen | tr "[:upper:]" "[:lower:]")
          TEST_IMAGE_URL=ttl.sh/${IMAGE_NAME}:1h
          crane copy cgr.dev/chainguard/static@$DIGEST $TEST_IMAGE_URL
          cosign initialize --mirror $TUF_MIRROR --root $TUF_MIRROR/root.json
          COSIGN_EXPERIMENTAL=1 cosign sign --rekor-url $REKOR_URL --fulcio-url $FULCIO_URL $TEST_IMAGE_URL --identity-token $OIDC_TOKEN -y
          echo "TEST_IMAGE_URL=$TEST_IMAGE_URL" >> $GITHUB_ENV
      # run tests
      - name: Test with Chainsaw
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          cd ./test/conformance/chainsaw/custom-sigstore && chainsaw test --config .chainsaw.yaml
      - name: Debug failure
        if: failure()
        uses: ./.github/actions/kyverno-logs

  deferred:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: deferred

  deleting-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2, 3, 4, 5]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: deleting-policies
          shard-index: ${{ matrix.shard-index }}
          shard-count: 6

  events:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: events

  exceptions:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: exceptions
          shard-index: ${{ matrix.shard-index }}
          shard-count: 3

  filter:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: filter

  force-failure-policy-ignore:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard,force-failure-policy-ignore
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: force-failure-policy-ignore

  generate:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: generate
          shard-index: ${{ matrix.shard-index }}
          shard-count: 12
          install-kubectl-evict: true

  generate-mutating-admission-policy:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.32.8, v1.33.4, v1.34.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kind-config: ./scripts/config/kind/vap-v1beta1.yaml
          kyverno-configs: standard,generate-mutating-admission-policy
          quarantined-tests: applyconfiguration
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: generate-mutating-admission-policy

  generate-validating-admission-policy:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: generate-validating-admission-policy

  generating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2, 3, 4, 5]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: generating-policies
          quarantined-tests: sync-modify-downstream
          shard-index: ${{ matrix.shard-index }}
          shard-count: 6
          install-kubectl-evict: true

  globalcontext:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: globalcontext

  image-validating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: image-validating-policies
          shard-index: ${{ matrix.shard-index }}
          shard-count: 3

  lease:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: lease

  mutate:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: mutate
          shard-index: ${{ matrix.shard-index }}
          shard-count: 3

  mutating-admission-policy-reports:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.32.8, v1.33.4, v1.34.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kind-config: ./scripts/config/kind/vap-v1beta1.yaml
          kyverno-configs: standard,mutating-admission-policy-reports
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: mutating-admission-policy-reports

  reports-exclude-result:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.34.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: exclude-result
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: reports-exclude-result

  mutating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: mutating-policies
          shard-index: ${{ matrix.shard-index }}
          shard-count: 3

  namespaced-deleting-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: namespaced-deleting-policies

  namespaced-generating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: namespaced-generating-policies
          quarantined-tests: sync-modify-downstream
          shard-index: ${{ matrix.shard-index }}
          shard-count: 3

  namespaced-image-validating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: namespaced-image-validating-policies

  namespaced-mutating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: namespaced-mutating-policies

  namespaced-validating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: namespaced-validating-policies
          shard-index: ${{ matrix.shard-index }}
          shard-count: 3

  openreports:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: openreports
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: openreports
          install-openreports: true

  policy-exceptions-disabled:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: default
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: policy-exceptions-disabled

  policy-validation:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: policy-validation

  rangeoperators:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: rangeoperators

  rbac:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        kyverno-configs: [standard, default, force-failure-policy-ignore]
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: ${{ matrix.kyverno-configs }}
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: rbac

  reports:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: reports
          shard-index: ${{ matrix.shard-index }}
          shard-count: 3

  sigstore-custom-tuf:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kind-config: ./scripts/config/kind/vap-v1beta1.yaml
          kyverno-configs: standard,sigstore-custom-tuf
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: sigstore-custom-tuf

  ttl:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard,ttl
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: ttl

  validate:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2, 3, 4, 5, 6, 7]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: validate
          shard-index: ${{ matrix.shard-index }}
          shard-count: 8

  validating-admission-policy-reports:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: validating-admission-policy-reports

  validating-policies:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1, 2, 3, 4]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: validating-policies
          shard-index: ${{ matrix.shard-index }}
          shard-count: 5

  verify-images:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        shard-index: [0, 1]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: verify-images
          shard-index: ${{ matrix.shard-index }}
          shard-count: 2

  verify-manifests:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: verify-manifests

  webhook-configurations:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: webhook-configurations

  webhooks:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: webhooks

  monitor-helm-secret-size:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.35.0]
    needs: [prepare]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install helm
        id: helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
      - name: Create kind cluster
        uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0
        with:
          node_image: kindest/node:${{ matrix.k8s-version }}
          cluster_name: kind
          config: ./scripts/config/kind/default.yaml
      - name: Download kyverno images archive
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: kyverno.tar
      - name: Load kyverno images archive in kind cluster
        shell: bash
        run: |
          set -e
          kind load image-archive kyverno.tar --name kind
      - name: Install kyverno
        shell: bash
        run: |
          set -ex
          export HELM=${{ steps.helm.outputs.helm-path }}
          make kind-install-kyverno
      - name: Wait for kyverno ready
        uses: ./.github/actions/kyverno-wait-ready
      - name: Check secret size
        shell: bash
        run: |
          set -e
          set -u
          SIZE=$(kubectl get secrets -n kyverno sh.helm.release.v1.kyverno.v1 -o jsonpath='{.data.release}' | base64 -d | wc -c | awk '{print $1}')
          MAX_ALLOWED=1030000
          if [ "$SIZE" -gt "$MAX_ALLOWED" ]; then
            echo "Helm secret size ($SIZE bytes) is above the max allowed ($MAX_ALLOWED bytes)"
            exit 1
          else
            echo "Helm secret size ($SIZE bytes) is below the max allowed ($MAX_ALLOWED bytes)"
          fi

  check-tests:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    needs:
      - prepare
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      # install tools
      - name: Download kyverno CLI archive
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: kubectl-kyverno
      - name: Install Cosign
        uses: sigstore/cosign-installer@fb28c2b6339dcd94da6e4cbcbc5e888961f6f8c3 # v3.9.0
      - name: Install chainsaw
        uses: kyverno/action-install-chainsaw@06560d18422209e9c1e08e931d477d04bf2674c1 # v0.2.14
        with:
          verify: true
          release: v0.2.15-beta.3
      # create cluster
      - name: Create kind cluster
        uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0
        with:
          node_image: kindest/node:v1.33.1
          cluster_name: kind
          config: ./scripts/config/kind/default.yaml
      - name: Install Kyverno CLI
        shell: bash
        run: |
          set -e
          chmod +x kubectl-kyverno && mv kubectl-kyverno ./cmd/cli/kubectl-kyverno/kyverno
          echo "$PWD/cmd/cli/kubectl-kyverno" >> $GITHUB_PATH
      # run tests
      - name: Test with Chainsaw
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          cd ./test/conformance/chainsaw/cli && chainsaw test --config .chainsaw.yaml

  helm-tests:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs:
      - prepare
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install helm
        id: helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
      - name: Create kind cluster
        uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0
        with:
          node_image: kindest/node:${{ matrix.k8s-version }}
          cluster_name: kind
          config: ./scripts/config/kind/default.yaml
      - name: Download kyverno images archive
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: kyverno.tar
      - name: Load kyverno images archive in kind cluster
        shell: bash
        run: |
          set -e
          kind load image-archive kyverno.tar --name kind
      - name: Install kyverno
        shell: bash
        run: |
          set -e
          export HELM=${{ steps.helm.outputs.helm-path }}
          make kind-install-kyverno
      - name: Wait for kyverno ready
        uses: ./.github/actions/kyverno-wait-ready
      - name: Helm test
        run: |
          set -e
          export HELM=${{ steps.helm.outputs.helm-path }}
          make helm-test
      - name: Debug failure
        if: failure()
        uses: ./.github/actions/kyverno-logs
      - name: Get logs from liveness pod
        if: failure()
        run: |
          kubectl -n kyverno logs pod/kyverno-cleanup-controller-liveness

  helm-uninstall:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
    needs:
      - prepare
    steps:
      - name: Checkout kyverno/kyverno
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install helm
        id: helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
      - name: Create kind cluster
        uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0
        with:
          node_image: kindest/node:${{ matrix.k8s-version }}
          cluster_name: kind
          config: ./scripts/config/kind/default.yaml
      - name: Download kyverno images archive
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: kyverno.tar
      - name: Load kyverno images archive in kind cluster
        shell: bash
        run: |
          set -e
          kind load image-archive kyverno.tar --name kind
      - name: Install kyverno
        shell: bash
        run: |
          set -e
          export HELM=${{ steps.helm.outputs.helm-path }}
          export USE_CONFIG=kyverno-cleanup
          make kind-install-kyverno
      - name: Wait for kyverno ready
        uses: ./.github/actions/kyverno-wait-ready
      - name: Uninstall kyverno
        shell: bash
        run: |
          set -e
          helm uninstall kyverno -n kyverno --wait --timeout 1m
      - name: Debug failure
        if: failure()
        uses: ./.github/actions/kyverno-logs

  helm-upgrade:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version: [v1.33.7, v1.34.2, v1.35.0]
        kyverno-version: ["3.6"]
    needs: [prepare]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install helm
        id: helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
      # create cluster
      - name: Create kind cluster
        uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0
        with:
          node_image: kindest/node:${{ matrix.k8s-version }}
          cluster_name: kind
          config: ./scripts/config/kind/default.yaml
      # deploy kyverno
      - name: Download kyverno images archive
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: kyverno.tar
      - name: Load kyverno images archive in kind cluster
        shell: bash
        run: |
          set -e
          kind load image-archive kyverno.tar --name kind
      - name: Install kyverno
        shell: bash
        run: |
          set -e
          ${{ steps.helm.outputs.helm-path }} install kyverno --namespace kyverno --create-namespace --wait \
            --repo https://kyverno.github.io/kyverno kyverno \
            --version ${{ matrix.kyverno-version }}
      - name: Wait for kyverno ready
        uses: ./.github/actions/kyverno-wait-ready
      - name: Upgrade kyverno
        shell: bash
        run: |
          set -e
          export HELM=${{ steps.helm.outputs.helm-path }}
          make kind-install-kyverno
      - name: Wait for kyverno ready
        uses: ./.github/actions/kyverno-wait-ready
      # debug
      - name: Debug failure
        if: failure()
        uses: ./.github/actions/kyverno-logs

  cert-manager-certificates:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - name: v1.33
            version: v1.33.1
        key-algorithm:
          - name: rsa
            test-dir: rsa-cert-manager
            helm-settings: --set admissionController.certManager.enabled=true --set admissionController.certManager.algorithm=RSA --set cleanupController.certManager.enabled=true --set cleanupController.certManager.algorithm=RSA
          - name: ecdsa
            test-dir: ecdsa-cert-manager
            helm-settings: --set admissionController.certManager.enabled=true --set admissionController.certManager.algorithm=ECDSA --set admissionController.certManager.size=256 --set cleanupController.certManager.enabled=true --set cleanupController.certManager.algorithm=ECDSA --set cleanupController.certManager.size=256
    needs:
      - prepare
    name: ${{ matrix.k8s-version.name }} - cert-manager ${{ matrix.key-algorithm.name }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version.version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: tls-certificates/${{ matrix.key-algorithm.test-dir }}
          install-cert-manager: 'true'
          explicit-install-settings: ${{ matrix.key-algorithm.helm-settings }}

  self-signed-certificates:
    # if: github.event_name == 'merge_group'
    runs-on: ubuntu-latest
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - name: v1.33
            version: v1.33.1
        key-algorithm:
          - name: ecdsa
            test-dir: ecdsa-self-signed
            helm-settings: --set admissionController.tlsKeyAlgorithm=ECDSA --set cleanupController.tlsKeyAlgorithm=ECDSA
          - name: ed25519
            test-dir: ed25519-self-signed
            helm-settings: --set admissionController.tlsKeyAlgorithm=Ed25519 --set cleanupController.tlsKeyAlgorithm=Ed25519
    needs:
      - prepare
    name: ${{ matrix.k8s-version.name }} - self-signed ${{ matrix.key-algorithm.name }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/run-tests
        with:
          k8s-version: ${{ matrix.k8s-version.version }}
          kyverno-configs: standard
          token: ${{ secrets.GITHUB_TOKEN }}
          tests-path: tls-certificates/${{ matrix.key-algorithm.test-dir }}
          explicit-install-settings: ${{ matrix.key-algorithm.helm-settings }}

  conformance-required-success:
    name: conformance-required
    needs:
      - assert
      - autogen
      - background-only
      - cleanup
      - custom-sigstore
      - deferred
      - deleting-policies
      - events
      - exceptions
      - filter
      - force-failure-policy-ignore
      - generate
      - generate-mutating-admission-policy
      - generate-validating-admission-policy
      - generating-policies
      - globalcontext
      - image-validating-policies
      - lease
      - mutate
      - mutating-admission-policy-reports
      - reports-exclude-result
      - mutating-policies
      - namespaced-deleting-policies
      - namespaced-generating-policies
      - namespaced-image-validating-policies
      - namespaced-mutating-policies
      - namespaced-validating-policies
      - openreports
      - policy-exceptions-disabled
      - policy-validation
      - rangeoperators
      - rbac
      - reports
      - sigstore-custom-tuf
      - ttl
      - validate
      - validating-admission-policy-reports
      - validating-policies
      - verify-images
      - verify-manifests
      - webhook-configurations
      - webhooks
      - monitor-helm-secret-size
      - check-tests
      - helm-tests
      - helm-uninstall
      - helm-upgrade
      - cert-manager-certificates
      - self-signed-certificates
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - run: ${{ true }}

  conformance-required-failure:
    name: conformance-required
    needs:
      - assert
      - autogen
      - background-only
      - cleanup
      - custom-sigstore
      - deferred
      - deleting-policies
      - events
      - exceptions
      - filter
      - force-failure-policy-ignore
      - generate
      - generate-mutating-admission-policy
      - generate-validating-admission-policy
      - generating-policies
      - globalcontext
      - image-validating-policies
      - lease
      - mutate
      - mutating-admission-policy-reports
      - reports-exclude-result
      - mutating-policies
      - namespaced-deleting-policies
      - namespaced-generating-policies
      - namespaced-image-validating-policies
      - namespaced-mutating-policies
      - namespaced-validating-policies
      - openreports
      - policy-exceptions-disabled
      - policy-validation
      - rangeoperators
      - rbac
      - reports
      - sigstore-custom-tuf
      - ttl
      - validate
      - validating-admission-policy-reports
      - validating-policies
      - verify-images
      - verify-manifests
      - webhook-configurations
      - webhooks
      - monitor-helm-secret-size
      - check-tests
      - helm-tests
      - helm-uninstall
      - helm-upgrade
      - cert-manager-certificates
      - self-signed-certificates
    runs-on: ubuntu-latest
    if: ${{ failure() || cancelled() }}
    steps:
      - run: ${{ false }}
