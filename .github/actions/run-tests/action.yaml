name: Runs E2E Tests
description: Runs E2E tests using chainsaw
inputs:
  k8s-version:
    description: Kubernetes version
    required: true
  kind-config:
    description: Kind cluster config
    default: ./scripts/config/kind/default.yaml
  kyverno-configs:
    description: Kyverno configs
    default: standard
  token:
    description: GH token
    required: true
  tests-path:
    description: Tests path
    default: '.'
  chainsaw-tests:
    description: Test regex
    default: ''
  shard-index:
    description: Shard index
    default: '0'
  shard-count:
    description: Shard count
    default: '0'
  quarantined-tests:
    description: tests to exclude from the run, comma separated
    default: ''
  install-cert-manager:
    description: Install cert-manager before running tests
    default: 'false'
  install-kubectl-evict:
    description: Install kubectl-evict before running tests
    default: 'false'
  install-openreports:
    description: install openreports crds
    default: 'false'
  explicit-install-settings:
    description: Additional helm install settings for Kyverno (e.g., --set admissionController.tlsKeyAlgorithm=Ed25519)
    default: ''
runs:
  using: composite
  steps:
    # install tools
    - name: Install helm
      id: helm
      uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
    - name: Install Cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
    - name: Setup yq
      uses: mikefarah/yq@5a7e72a743649b1b3a47d1a1d8214f3453173c51 # v4.52.4
    - name: Install chainsaw
      uses: kyverno/action-install-chainsaw@06560d18422209e9c1e08e931d477d04bf2674c1 # v0.2.14
      with:
        verify: true
        release: v0.2.15-beta.3
    # create cluster
    - name: Create kind cluster
      uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0
      with:
        node_image: kindest/node:${{ inputs.k8s-version }}
        cluster_name: kind
        config: ${{ inputs.kind-config }}
    # deploy kyverno
    - name: Download kyverno images archive
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: kyverno.tar
    - name: Load kyverno images archive in kind cluster
      shell: bash
      run: |
        set -e
        kind load image-archive kyverno.tar --name kind
    - name: Install OpenReports
      if: inputs.install-openreports == 'true'
      shell: bash
      run: |
        kubectl apply -f https://raw.githubusercontent.com/openreports/reports-api/refs/heads/main/config/install.yaml
    - name: Install cert-manager
      if: inputs.install-cert-manager == 'true'
      shell: bash
      run: |
        set -e
        helm repo add jetstack https://charts.jetstack.io
        helm install cert-manager jetstack/cert-manager \
          --namespace cert-manager --create-namespace \
          --set crds.enabled=true --wait --timeout 300s
    - name: Install Kyverno
      shell: bash
      run: |
        set -ex
        export HELM=${{ steps.helm.outputs.helm-path }}
        export USE_CONFIG=${{ inputs.kyverno-configs }}
        export EXPLICIT_INSTALL_SETTINGS="${{ inputs.explicit-install-settings }}"
        echo "Installing Kyverno from main"
        make kind-install-kyverno
    - name: Install kubectl-evict
      if: inputs.install-kubectl-evict == 'true'
      shell: bash
      run: |
        set -e
        GOBIN=$(go env GOPATH)/bin
        go install github.com/ueokande/kubectl-evict@latest
        echo 'Adding kubectl-evict directory to PATH...'
        echo "${GOBIN}" >> "${GITHUB_PATH}"
    - name: Wait for kyverno ready
      uses: ./.github/actions/kyverno-wait-ready
    - name: Add excluded tests
      shell: bash
      run: |
        if [ -z "${{ inputs.quarantined-tests }}" ]; then
          echo "no quarantined tests, skipping"
          exit 0
        fi

        IFS=',' read -ra TEST_DIRS <<< "${{ inputs.quarantined-tests }}"

        for DIR_NAME in "${TEST_DIRS[@]}"; do
          # Find ALL matching directories
          mapfile -t FOUND_DIRS < <(find ./test/conformance/chainsaw/${{ inputs.tests-path }} -type d -name "$DIR_NAME")

          if [ ${#FOUND_DIRS[@]} -eq 0 ]; then
            echo "Error: No directories found matching '$DIR_NAME'"
            continue
          fi

          for FOUND_TEST_DIR in "${FOUND_DIRS[@]}"; do
            echo "Found directory: $FOUND_TEST_DIR"

            TEST_FILE="$FOUND_TEST_DIR/chainsaw-test.yaml"
            if [ ! -f "$TEST_FILE" ]; then
              echo "Error: chainsaw-test.yaml not found in $FOUND_TEST_DIR"
              continue
            fi

            yq eval '.spec.skip = true' -i "$TEST_FILE"
            echo "Set skip: true in $TEST_FILE"
          done
        done
    # run tests
    - name: Test with Chainsaw
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        set -e
        cd ./test/conformance/chainsaw/${{ inputs.tests-path }}
        chainsaw test \
          --config .chainsaw.yaml \
          --include-test-regex '^chainsaw$/${{ inputs.chainsaw-tests }}' \
          --shard-index ${{ inputs.shard-index }} \
          --shard-count ${{ inputs.shard-count }}
    # debug
    - name: Debug failure
      if: failure()
      uses: ./.github/actions/kyverno-logs
